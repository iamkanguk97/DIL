# SSH (Secure Shell)

## 정의

**네트워크 프로토콜 중 하나로 인터넷과 같이 안전하지 않은 Public Network를 통해서 컴퓨터와 컴퓨터가 서로 통신할 때, 안전하고 암호화된 방식으로 원격 컴퓨터에 접속하거나 데이터를 전송하기 위한 프로토콜입니다.**

과거에는 [`Telnet`](https://velog.io/@jeongbeom4693/SSH%EC%99%80-Telnet)과 같은 네트워크 프로토콜이 원격 접속에 사용되었는데 **데이터를 암호화하지 않고 평문으로 전송을 하기 때문에 중간에 비밀번호와 같은 중요한 정보가 탈취되는 위험성**이 존재했습니다. 이러한 보안 취약점을 해결하기 위해 `SSH`가 등장했습니다.

대표적인 사용 예시는 `데이터 전송`과 `원격 제어`가 있을 것 같습니다. `데이터 전송`은 `GitHub`을 대표적인 예시로 낼 수 있을 것 같은데, **개발자가 작성한 소스코드를 원격 저장소인 GitHub에 Push할 때 SSH를 활용해서 파일을 전송**합니다.

`원격 제어`는 `AWS와 같은 클라우드 서비스`를 이용할 때 AWS 인스턴스 서버에 접속하기 위해서는 SSH를 사용합니다.

`FTP 또는 Telnet`을 사용하게 되면 로그인 정보와 같은 민감한 정보를 직접 네트워크를 통해 넘기기 때문에 위험하지만, `SSH`를 사용하게 되면 **안전한 채널을 먼저 구성한 뒤**에 정보를 교환하기 때문에 보다 보안적인 측면에서 뛰어나다고 할 수 있습니다.

## 작동 원리

![SSH 작동 원리](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2F9GCt8%2FbtrpeJf009q%2FOYO7lR1zQebcJXZjI6Ov5k%2Fimg.webp)

-   `클라이언트-서버 모델`: 클라이언트(접속시도 컴퓨터)와 서버(접속허용 원격 컴퓨터) 간의 통신을 기반으로 합니다.
-   기본적으로 `TCP 22번` 포트 활용
-   `암호화 방식`
    -   **비대칭키 암호화**: 서버 인증 및 사용자 인증에 사용됩니다.
    -   **대칭키 암호화**: 데이터 전송시 사용됩니다.

### (1) 연결 설정 및 버전 교환

-   `클라이언트 요청`: 클라이언트가 원격 서버의 TCP 22번 포트로 SSH 접속 요청을 보냅니다.
-   `서버 응답`: 클라이언트에게 서버에서 지원하는 SSH 프로토콜 버전을 응답으로 보냅니다.
-   `버전 일치 확인`: 클라이언트는 서버가 지원하는 버전 중 일치하는 버전이 있으면 연결을 진행합니다.

### (2) 키 교환 및 세션 키 생성 (대칭키 사용 준비)

> **Diffie-Hellman 키 교환 알고리즘과 같은 비대칭키 기반 알고리즘을 활용해서 클라이언트와 서버가 대칭키(세션키)를 안전하게 공유하는 과정입니다.**

-   `알고리즘 협상`: 클라이언트와 서버는 서로 지원하는 **암호화 알고리즘(AES 등), 해시 알고리즘, 키 교환 알고리즘** 등을 협상해서 사용할 알고리즘을 결정합니다.
-   `임시 공개키 교환`: 클라이언트와 서버는 **각각 임시적인 공개키와 개인키 쌍을 생성하고 서로의 공개키를 교환**합니다.
-   `세션키 생성`: **교환된 공개키와 각자가 보유한 개인키, 그리고 사전에 합의된 파라미터들을 이용해서 동일한 세션키를 독립적으로 생성**합니다.
    -   `Diffie-Hellman` 알고리즘을 활용해서 대칭키(세션키)를 생성합니다.
        > [!NOTE]
        > 서버와 클라이언트가 보유한 개인키와 공개키가 각자 다른데, 어떻게 서버와 클라이언트가 동일한 대칭키를 받을 수 있을까?
        > => Diffie-Hellman 알고리즘의 내부 동작방식으로 인해 가능합니다! (상호간 공유한 파라미터와 개인키/공개키를 활용)
-   `MAC(Message Authentication Code)` 생성: 데이터 무결성을 보장하기 위한 키를 생성합니다.

### (3) 서버 인증 (Host Authentication)

> 클라이언트가 접속하려는 서버가 신뢰할 수 있는 서버인지 확인해야 합니다. 해당 과정에서는 비대칭키 방식을 사용합니다.

-   서버 공개키 전달: 서버는 클라이언트에게 서버의 공개키를 전송합니다.
-   클라이언트의 확인
    -   최초 접속시: 클라이언트가 해당 서버에 처음 접속하는 경우, 서버의 공개키(지문, fingerprint)를 로컬(ssh의 known_hosts)에 저장할지 묻는 메세지가 출력됨
    -   재접속시: 클라이언트는 `known_hosts` 파일에 저장된 서버의 공개키와 현재 서버가 보내온 공개키를 비교해서 일치할 경우에 통신을 진행합니다.
-   서버의 암호화된 난수 전송: 서버는 임의의 난수를 생성하고, 이 난수를 클라이언트에게 전달한 자신의 개인키로

### (4) 사용자 인증 (User Authentication)

> **서버가 접속을 시도하는 클라이언트 사용자가 해당 서버에 접근할 권한이 있는지 확인하는 과정입니다. 패스워드 방식과 공개키 방식이 사용됩니다.**

-   패스워드 방식
    -   클라이언트는 사용자ID와 패스워드를 입력합니다.
    -   입력된 정보는 세션키(대칭키)로 암호화 되어 서버로 전송됩니다.
    -   서버는 전송받은 정보를 복호화하여 비교해서 인증합니다.
    -   하지만, 패스워드의 복잡성 설정의 한계가 있기 때문에 선호하지 않는 방법입니다.
-   공개키 인증 (SSH 키 쌍)
    -   클라이언트는 미리 공개키와 개인키 한 쌍을 생성하고 서버로 전송합니다.
    -   서버는 클라이언트가 접속하고자 하는 계정의 `.ssh/authorized_keys` 파일을 확인합니다.
    -   매칭되는 공개키가 있다면, 서버는 난수를 생성하고 클라이언트의 공개키로 암호화해서 클라이언트로 전송합니다.

---

## References

-   https://limvo.tistory.com/21
-   https://velog.io/@realsy/SSHSecure-Shell%EC%9D%98-%EC%9B%90%EB%A6%AC%EC%99%80-%EC%82%AC%EC%9A%A9%EB%B0%A9%EB%B2%95-%EC%95%8C%EC%95%84%EB%B3%B4%EA%B8%B0
-   https://southouse.tistory.com/10
